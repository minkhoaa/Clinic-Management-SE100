@startuml

' ========== THESIS STANDARD CONFIGURATION ==========
skinparam handwritten false
skinparam shadowing false
skinparam monochrome true
skinparam defaultFontName Arial
skinparam defaultFontSize 11

skinparam activity {
    StartColor Black
    EndColor Black
    BackgroundColor White
    BorderColor Black
    ArrowColor Black
    DiamondBorderColor Black
    DiamondBackgroundColor White
}

skinparam swimlane {
    BorderColor Black
    TitleBackgroundColor White
    TitleFontColor Black
}

title Activity Diagram: Quy trình thanh toán qua VNPay

|Lễ tân|
start
:Tra cứu hóa đơn của bệnh nhân;
:Chọn phương thức thanh toán VNPay;

|Hệ thống|
:Truy vấn thông tin hóa đơn;

if (Hóa đơn hợp lệ?) then ([Có])
    :Tạo mã giao dịch (TxnRef);
    :Tạo chữ ký bảo mật (HMAC);
    :Xây dựng URL thanh toán VNPay;
    :Trả về Payment URL;
else ([Không])
    :Thông báo hóa đơn không hợp lệ;
    stop
endif

|Lễ tân|
:Hiển thị QR Code / Link thanh toán;

|Bệnh nhân|
:Quét QR hoặc truy cập link;

|VNPay Gateway|
:Hiển thị trang thanh toán;
:Yêu cầu chọn ngân hàng;

|Bệnh nhân|
:Chọn ngân hàng thanh toán;
:Nhập thông tin thẻ/tài khoản;
:Xác nhận thanh toán;

|VNPay Gateway|
:Gửi yêu cầu đến ngân hàng;
:Nhận kết quả từ ngân hàng;

if (Giao dịch thành công?) then ([Có])
    :Gọi IPN Callback (Server-to-Server);
    
    |Hệ thống|
    :Nhận IPN request;
    :Xác thực chữ ký HMAC;
    
    if (Chữ ký hợp lệ?) then ([Có])
        :Bắt đầu transaction;
        :Cập nhật hóa đơn: Paid;
        :Ghi nhận phương thức: VNPay;
        :Ghi nhận mã giao dịch VNPay;
        
        :Truy vấn thuốc trong hóa đơn;
        
        if (Có thuốc?) then ([Có])
            :Trừ số lượng tồn kho;
        else ([Không])
        endif
        
        :Commit transaction;
        :Trả về: Confirm Success;
        
        |VNPay Gateway|
        :Redirect bệnh nhân về trang kết quả;
        
        |Bệnh nhân|
        :Xem thông báo thanh toán thành công;
        
        |Lễ tân|
        :Nhận thông báo thanh toán thành công;
        :In hóa đơn (nếu cần);
        stop
        
    else ([Không])
        :Trả về: Invalid Signature;
        |VNPay Gateway|
        :Ghi nhận lỗi xác thực;
        stop
    endif
    
else ([Không])
    :Redirect về trang lỗi;
    
    |Bệnh nhân|
    :Xem thông báo thanh toán thất bại;
    
    |Lễ tân|
    :Nhận thông báo thanh toán thất bại;
    :Đề xuất thanh toán lại hoặc đổi phương thức;
    stop
endif

@enduml
