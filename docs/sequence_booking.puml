@startuml

' ========== THESIS STANDARD CONFIGURATION ==========
skinparam handwritten false
skinparam shadowing false
skinparam monochrome true
skinparam responseMessageBelowArrow true
skinparam defaultFontName Arial
skinparam defaultFontSize 11

skinparam sequence {
    LifeLineBorderColor Black
    LifeLineBackgroundColor White
    ParticipantBorderColor Black
    ParticipantBackgroundColor White
    ActorBorderColor Black
    ActorBackgroundColor White
    ArrowColor Black
}

title Sequence Diagram: Đặt lịch hẹn khám nha khoa

' ========== PARTICIPANTS ==========
actor "Bệnh nhân" as Patient
boundary "BookingPage" as UI1
control "BookingController" as Controller
entity "UserService" as Service
database "Database" as DB
entity "EmailService" as Email

autonumber

' ========== MAIN FLOW ==========
Patient -> UI : Truy cập trang đặt lịch
activate UI

UI -> Controller : GET /api/clinics
activate Controller
Controller -> Service : GetClinicsAsync()
activate Service
Service -> DB : SELECT * FROM Clinics
activate DB
DB --> Service : Danh sách phòng khám
deactivate DB
Service --> Controller : List<ClinicDto>
deactivate Service
Controller --> UI : 200 OK (clinics)
deactivate Controller

UI -> Controller : GET /api/doctors?clinicId={id}
activate Controller
Controller -> Service : GetDoctorsAsync(clinicId)
activate Service
Service -> DB : SELECT * FROM Doctors WHERE ClinicId = ?
activate DB
DB --> Service : Danh sách nha sĩ
deactivate DB
Service --> Controller : List<DoctorDto>
deactivate Service
Controller --> UI : 200 OK (doctors)
deactivate Controller

UI -> Controller : GET /api/slots?doctorId={id}&date={date}
activate Controller
Controller -> Service : GetSlotsAsync(doctorId, date)
activate Service
Service -> DB : SELECT * FROM DoctorAvailability
activate DB
DB --> Service : Lịch làm việc
deactivate DB
Service -> DB : SELECT * FROM Appointments (booked)
activate DB
DB --> Service : Lịch đã đặt
deactivate DB
Service -> Service : Tính toán slots trống
Service --> Controller : List<SlotDto>
deactivate Service
Controller --> UI : 200 OK (available slots)
deactivate Controller

UI --> Patient : Hiển thị slots trống
Patient -> UI : Chọn slot & nhập thông tin
UI -> Controller : POST /api/appointments
activate Controller
Controller -> Service : CreateBookingAsync(request)
activate Service

' ========== VALIDATION ==========
Service -> DB : Check trùng lịch
activate DB
DB --> Service : Kết quả kiểm tra
deactivate DB

alt Slot đã bị đặt
    Service --> Controller : 409 Conflict
    Controller --> UI : Slot đã có người đặt
    UI --> Patient : Thông báo lỗi
else Slot còn trống
    Service -> DB : INSERT INTO Appointments
    activate DB
    DB --> Service : Appointment created
    deactivate DB
    
    Service -> DB : INSERT INTO AppointmentTokens
    activate DB
    DB --> Service : Tokens created
    deactivate DB
    
    Service -> Email : SendBookingConfirmationAsync()
    activate Email
    Email --> Service : Email sent
    deactivate Email
    
    Service --> Controller : AppointmentResponse
    deactivate Service
    Controller --> UI : 201 Created
    deactivate Controller
    UI --> Patient : Đặt lịch thành công
end

deactivate UI

@enduml
