@startuml

' ========== THESIS STANDARD CONFIGURATION ==========
skinparam handwritten false
skinparam shadowing false
skinparam monochrome true
skinparam responseMessageBelowArrow true
skinparam defaultFontName Arial
skinparam defaultFontSize 11

skinparam sequence {
    LifeLineBorderColor Black
    LifeLineBackgroundColor White
    ParticipantBorderColor Black
    ParticipantBackgroundColor White
    ActorBorderColor Black
    ActorBackgroundColor White
    ArrowColor Black
}

title Sequence Diagram: Thanh toán qua VNPay

' ========== PARTICIPANTS ==========
actor "Lễ tân" as Cashier
actor "Bệnh nhân" as Patient
boundary "BillingPage" as UI
control "BillingController" as Controller
entity "BillingService" as Service
database "Database" as DB
participant "VNPay Gateway" as VNPay

autonumber

' ========== CREATE PAYMENT URL ==========
Cashier -> UI : Chọn thanh toán VNPay
activate UI

UI -> Controller : POST /api/billing/vnpay/create-payment-url
activate Controller
Controller -> Service : CreatePaymentUrlAsync(billId, returnUrl)
activate Service

Service -> DB : SELECT * FROM Bills WHERE Id = ?
activate DB
DB --> Service : Bill info
deactivate DB

alt Hóa đơn không hợp lệ
    Service --> Controller : 400 Bad Request
    Controller --> UI : Hóa đơn không hợp lệ
    UI --> Cashier : Thông báo lỗi
else Hóa đơn hợp lệ
    Service -> Service : Build VNPay params + HMAC signature
    Service --> Controller : Payment URL
    deactivate Service
    Controller --> UI : 200 OK (paymentUrl)
    deactivate Controller
    UI --> Cashier : Hiển thị QR code / Link thanh toán
end

' ========== PATIENT PAYS ==========
Cashier -> Patient : Hướng dẫn quét QR / truy cập link
Patient -> VNPay : Truy cập link thanh toán
activate VNPay
VNPay --> Patient : Hiển thị trang thanh toán VNPay
Patient -> VNPay : Chọn ngân hàng, xác nhận thanh toán
VNPay -> VNPay : Xử lý giao dịch với ngân hàng

alt Thanh toán thất bại
    VNPay --> Patient : Thông báo lỗi
    VNPay -> Controller : GET /api/billing/vnpay/return?vnp_ResponseCode=XX
    activate Controller
    Controller -> Service : ReturnUrlAsync(params)
    activate Service
    Service -> Service : Verify signature
    Service --> Controller : Redirect to error page
    deactivate Service
    Controller --> UI : Redirect (error)
    deactivate Controller
    UI --> Cashier : Thanh toán thất bại
    
else Thanh toán thành công
    VNPay --> Patient : Thanh toán thành công
    
    ' ========== IPN CALLBACK (Server-to-Server) ==========
    VNPay -> Controller : POST /api/billing/vnpay/ipn
    activate Controller
    Controller -> Service : IpnUrlAsync(params)
    activate Service
    
    Service -> Service : Verify HMAC signature
    
    Service -> DB : BEGIN TRANSACTION
    activate DB
    
    Service -> DB : SELECT * FROM Bills WHERE Id = ?
    DB --> Service : Bill
    
    Service -> DB : UPDATE Bills SET Status = 'Paid', PaymentMethod = 'VnPay'
    DB --> Service : Updated
    
    Service -> DB : COMMIT
    DB --> Service : Committed
    deactivate DB
    
    Service --> Controller : { RspCode: "00", Message: "Confirm Success" }
    deactivate Service
    Controller --> VNPay : 200 OK
    deactivate Controller
    deactivate VNPay
    
    ' ========== RETURN URL (User redirect) ==========
    VNPay -> Controller : GET /api/billing/vnpay/return?vnp_ResponseCode=00
    activate Controller
    Controller -> Service : ReturnUrlAsync(params)
    activate Service
    Service --> Controller : Redirect to success page
    deactivate Service
    Controller --> UI : Redirect (success)
    deactivate Controller
    UI --> Cashier : Thanh toán thành công
end

deactivate UI

@enduml
