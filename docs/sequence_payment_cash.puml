@startuml

' ========== THESIS STANDARD CONFIGURATION ==========
skinparam handwritten false
skinparam shadowing false
skinparam monochrome true
skinparam responseMessageBelowArrow true
skinparam defaultFontName Arial
skinparam defaultFontSize 11

skinparam sequence {
    LifeLineBorderColor Black
    LifeLineBackgroundColor White
    ParticipantBorderColor Black
    ParticipantBackgroundColor White
    ActorBorderColor Black
    ActorBackgroundColor White
    ArrowColor Black
}

title Sequence Diagram: Thanh toán tiền mặt

' ========== PARTICIPANTS ==========
actor "Lễ tân" as Cashier
boundary "BillingPage" as UI
control "BillingController" as Controller
entity "BillingService" as Service
database "Database" as DB

autonumber

' ========== VIEW BILLS ==========
Cashier -> UI : Xem danh sách hóa đơn chờ thanh toán
activate UI

UI -> Controller : GET /api/billing?status=Pending
activate Controller
Controller -> Service : GetBillsAsync(status)
activate Service
Service -> DB : SELECT * FROM Bills WHERE Status = 'Pending'
activate DB
DB --> Service : Pending bills
deactivate DB
Service --> Controller : List<BillDto>
deactivate Service
Controller --> UI : 200 OK (bills)
deactivate Controller

UI --> Cashier : Hiển thị danh sách hóa đơn

' ========== VIEW BILL DETAIL ==========
Cashier -> UI : Chọn hóa đơn để xem chi tiết
UI -> Controller : GET /api/billing/{billId}
activate Controller
Controller -> Service : GetBillDetailAsync(billId)
activate Service
Service -> DB : SELECT * FROM Bills JOIN BillItems WHERE BillId = ?
activate DB
DB --> Service : Bill + Items
deactivate DB
Service --> Controller : BillDetailDto
deactivate Service
Controller --> UI : 200 OK (bill detail)
deactivate Controller

UI --> Cashier : Hiển thị chi tiết hóa đơn

' ========== PAYMENT ==========
Cashier -> UI : Nhập số tiền khách đưa và thanh toán
UI -> Controller : POST /api/billing/{billId}/pay
activate Controller
Controller -> Service : PayBillAsync(billId, request)
activate Service

Service -> DB : SELECT * FROM Bills WHERE Id = ?
activate DB
DB --> Service : Bill
deactivate DB

alt Hóa đơn không tồn tại
    Service --> Controller : 404 Not Found
    Controller --> UI : Không tìm thấy hóa đơn
    UI --> Cashier : Thông báo lỗi
    
else Hóa đơn đã thanh toán
    Service --> Controller : 400 Bad Request
    Controller --> UI : Hóa đơn đã được thanh toán
    UI --> Cashier : Thông báo lỗi
    
else Số tiền không đủ
    Service --> Controller : 400 Bad Request
    Controller --> UI : Số tiền thanh toán không đủ
    UI --> Cashier : Thông báo lỗi
    
else Thanh toán thành công
    Service -> DB : BEGIN TRANSACTION
    activate DB
    
    Service -> DB : UPDATE Bills SET Status = 'Paid', PaidAmount = ?, ChangeAmount = ?
    DB --> Service : Updated
    
    Service -> DB : COMMIT
    DB --> Service : Committed
    deactivate DB
    
    Service --> Controller : Success (ChangeAmount)
    deactivate Service
    Controller --> UI : 200 OK
    deactivate Controller
    UI --> Cashier : Thanh toán thành công, tiền thừa: X VNĐ
end

deactivate UI

@enduml
