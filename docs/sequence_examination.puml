@startuml

' ========== THESIS STANDARD CONFIGURATION ==========
skinparam handwritten false
skinparam shadowing false
skinparam monochrome true
skinparam responseMessageBelowArrow true
skinparam defaultFontName Arial
skinparam defaultFontSize 11

skinparam sequence {
    LifeLineBorderColor Black
    LifeLineBackgroundColor White
    ParticipantBorderColor Black
    ParticipantBackgroundColor White
    ActorBorderColor Black
    ActorBackgroundColor White
    ArrowColor Black
}

title Sequence Diagram: Khám và điều trị nha khoa

' ========== PARTICIPANTS ==========
actor "Nha sĩ" as Doctor
boundary "DoctorPage" as UI
control "DoctorController" as Controller
entity "DoctorPracticeService" as Service
database "Database" as DB

autonumber

' ========== VIEW QUEUE ==========
Doctor -> UI : Xem hàng đợi bệnh nhân
activate UI

UI -> Controller : GET /api/doctor/queue
activate Controller
Controller -> Service : GetQueueAsync(user)
activate Service
Service -> DB : SELECT * FROM Appointments WHERE DoctorId = ? AND Date = today
activate DB
DB --> Service : Queue items
deactivate DB
Service --> Controller : List<QueueDetailDto>
deactivate Service
Controller --> UI : 200 OK (queue)
deactivate Controller

UI --> Doctor : Hiển thị hàng đợi

' ========== START EXAM ==========
Doctor -> UI : Bắt đầu khám bệnh nhân
UI -> Controller : POST /api/doctor/appointments/{id}/start
activate Controller
Controller -> Service : StartExamAsync(user, appointmentId)
activate Service

Service -> DB : SELECT * FROM Appointments WHERE Id = ?
activate DB
DB --> Service : Appointment
deactivate DB

alt Trạng thái không hợp lệ
    Service --> Controller : 400 Bad Request
    Controller --> UI : Bệnh nhân chưa check-in
    UI --> Doctor : Thông báo lỗi
else Trạng thái hợp lệ
    Service -> DB : UPDATE SET Status = 'InProgress', ActualStartTime = NOW()
    activate DB
    DB --> Service : Updated
    deactivate DB
    Service --> Controller : Success
    deactivate Service
    Controller --> UI : 200 OK
    deactivate Controller
    UI --> Doctor : Bắt đầu khám thành công
end

' ========== VIEW PATIENT HISTORY ==========
Doctor -> UI : Xem lịch sử khám của bệnh nhân
UI -> Controller : GET /api/doctor/patients/{patientId}
activate Controller
Controller -> Service : GetPatientDetailAsync(user, patientId)
activate Service
Service -> DB : SELECT * FROM MedicalRecords WHERE PatientId = ?
activate DB
DB --> Service : Medical history
deactivate DB
Service --> Controller : PatientDetailDto
deactivate Service
Controller --> UI : 200 OK (patient + history)
deactivate Controller
UI --> Doctor : Hiển thị thông tin và lịch sử

' ========== CREATE EXAMINATION ==========
Doctor -> UI : Nhập chẩn đoán, điều trị, đơn thuốc
UI -> Controller : POST /api/doctor/examinations
activate Controller
Controller -> Service : CreateExaminationAsync(user, request)
activate Service

Service -> DB : SELECT * FROM Patients WHERE Id = ?
activate DB
DB --> Service : Patient exists
deactivate DB

Service -> DB : INSERT INTO MedicalRecords
activate DB
DB --> Service : MedicalRecord created
deactivate DB

alt Tạo hóa đơn (CreateBill = true)
    Service -> DB : SELECT * FROM Services WHERE Id IN (...)
    activate DB
    DB --> Service : Services info
    deactivate DB
    
    Service -> DB : INSERT INTO Bills
    activate DB
    DB --> Service : Bill created
    deactivate DB
    
    Service -> DB : INSERT INTO BillItems
    activate DB
    DB --> Service : BillItems created
    deactivate DB
end

Service -> DB : UPDATE Appointments SET Status = 'Completed'
activate DB
DB --> Service : Updated
deactivate DB

Service --> Controller : ExaminationResponse
deactivate Service
Controller --> UI : 201 Created
deactivate Controller
UI --> Doctor : Hoàn thành khám

deactivate UI

@enduml
